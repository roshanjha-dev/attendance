<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Barcode Attendance</title>
    <script src="https://unpkg.com/quagga"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { 
            text-align: center; 
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f8f9fa;
        }
        #scanner-container { 
            width: 90vw; /* Responsive width */
            height: 250px; /* Adjusted height */
            max-width: 400px; /* Prevents too large on tablets */
            margin: 10px auto;
            border: 2px solid #000;
            border-radius: 10px;
            overflow: hidden;
        }
        #data { 
            font-size: 18px; 
            font-weight: bold; 
            background: #000;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            display: inline-block;
            margin-top: 10px;
        }
        button, input { 
            width: 90%;
            max-width: 300px;
            margin: 10px auto;
            padding: 12px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            border: none;
            display: block;
            background-color: #007bff;
            color: white;
        }
        button:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <h2>ðŸ“· Scan Barcode for Attendance</h2>

    <!-- Camera Scanner -->
    <div id="scanner-container"></div>

    <!-- Display Scanned Data -->
    <p id="data">Scan a barcode...</p>

    <!-- Upload Excel File -->
    <input type="file" id="fileInput" accept=".xlsx" />

    <!-- Download Updated File -->
    <button onclick="downloadExcel()">ðŸ“¥ Download Updated Sheet</button>

    <script>
        let workbook, sheet, sheetData = [];

        // Load Excel File
        document.getElementById("fileInput").addEventListener("change", function(event) {
            let file = event.target.files[0];
            let reader = new FileReader();
            
            reader.onload = function(e) {
                let data = new Uint8Array(e.target.result);
                workbook = XLSX.read(data, { type: "array" });
                sheet = workbook.Sheets[workbook.SheetNames[0]];
                sheetData = XLSX.utils.sheet_to_json(sheet, { header: 1 }); // Convert sheet to array
                console.log("Excel Loaded:", sheetData);
            };
            reader.readAsArrayBuffer(file);
        });

        // Initialize Scanner
        function startScanner() {
            Quagga.init({
                inputStream: {
                    type: "LiveStream",
                    constraints: { facingMode: "environment", width: 320, height: 240 },
                    target: document.querySelector("#scanner-container")
                },
                decoder: { readers: ["code_128_reader", "ean_reader", "upc_reader"] } // Barcode types
            }, function(err) {
                if (err) {
                    console.error(err);
                    return;
                }
                Quagga.start();
            });

            Quagga.onDetected(function(result) {
                let rollNo = result.codeResult.code;
                document.getElementById("data").innerText = "Scanned: " + rollNo;
                markAttendance(rollNo);
            });
        }

        // Mark Attendance in Excel
        function markAttendance(rollNo) {
            let found = false;
            for (let i = 1; i < sheetData.length; i++) { // Ignore header row
                if (sheetData[i][0] == rollNo) { // Roll No. is in column A (index 0)
                    sheetData[i][1] = "P"; // Mark Present in column B (index 1)
                    found = true;
                    break;
                }
            }
            if (!found) {
                alert("Roll No. " + rollNo + " not found in sheet!");
            }
        }

        // Download Updated Excel File
        function downloadExcel() {
            let ws = XLSX.utils.aoa_to_sheet(sheetData);
            let wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Attendance");
            XLSX.writeFile(wb, "Updated_Attendance.xlsx");
        }

        startScanner(); // Start barcode scanning when page loads
    </script>
</body>
</html>
